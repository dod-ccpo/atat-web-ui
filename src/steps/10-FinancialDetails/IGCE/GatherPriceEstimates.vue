<template>
  <v-container fluid class="container-max-width _anticipated-users-accordion">
    <v-row>
      <v-col class="col-12">
        <h1 class="page-header">
          Let’s work on price estimates for your performance requirements
        </h1>
        <p class="page-paragraph">
          Using the report generated from the previous screen, specify the
          projected price for each of your cloud service and support
          requirements. Edit any pre-filled details, as needed, to provide a
          more accurate description of what you are estimating (e.g., specific
          product/service names or configuration summaries generated by CSP
          calculator). We’ll use this info to populate total projected prices
          for each period of your task order later.
          <a
            role="button"
            id="OpenLearnMore"
            tabindex="0"
            
          >
          <!-- @click="openSlideoutPanel"
            @keydown.enter="openSlideoutPanel"
            @keydown.space="openSlideoutPanel" -->
            View Price Estimate FAQs
          </a>
        </p>
        <div class="_price-estimates-accordion">
          <v-expansion-panels
           
            v-for="(value, name, index) in estimateDataSource"
            :id="'AnticipatedUserAndDataNeedsAccordion' + index"
            :key="index"
            class="mb-4"
            flat
          >
            <v-expansion-panel expand>
              <v-expansion-panel-header>
                <div class="d-flex">
                  <div class="h4 _expansion-panel-header">
                    {{ name }}
                  </div>
                  <div class="offering-number">
                    {{ value.length }}
                  </div>
                </div>
              </v-expansion-panel-header>
              <v-expansion-panel-content>
                <div>
                  <div class="_expansion-panel-content-header">
                    <div class="summary-text">Service Name and Configuration Summary</div>
                    <div class="estimate-price-text">Estimated price per unit</div>
                  </div>
                  <Card_Requirement
                    v-for="(requirement, idx) in value"
                    :cardData="value[idx]"
                    :key="idx"
                    :index="idx + 1"
                  />
                </div>
              </v-expansion-panel-content>
            </v-expansion-panel>
          </v-expansion-panels>
        </div>
      </v-col>
    </v-row>
  </v-container>
</template>


<script lang="ts">
import { Component, Mixins } from "vue-property-decorator";
import SlideoutPanel from "@/store/slideoutPanel";
import {
  OtherServiceOfferingData,
  SlideoutPanelContent,
} from "../../../../types/Global";
// eslint-disable-next-line camelcase
/* eslint-disable camelcase */
import SlideOut_GatherPricesEstimates from 
  "@/steps/10-FinancialDetails/IGCE/components/SlideOut_GatherPricesEstimates.vue";
import Card_Requirement from "@/steps/10-FinancialDetails/IGCE/components/Card_Requirement.vue";
import IGCE from "@/store/IGCE";
import _ from "lodash";
import SaveOnLeave from "@/mixins/saveOnLeave";
import AcquisitionPackage from "@/store/acquisitionPackage";
import { IgceEstimateDTO, ReferenceColumn } from "@/api/models";
import ClassificationRequirements from "@/store/classificationRequirements";


@Component({
  components: { 
    Card_Requirement
  },
})
export default class GatherPriceEstimates extends Mixins(SaveOnLeave) {
  
  igceEstimateData: IgceEstimateDTO[] = [];
  estimateDataSource: never[] = [];


  private async loadOnEnter(): Promise<void> {
    await IGCE.loadIgceEstimateByPackageId(AcquisitionPackage.packageId);
    const classifications =
      await ClassificationRequirements.getSelectedClassificationLevels();
    const cloudServices = DescriptionOfWork.cloudSupportServices;
    this.selectedClassifications = classifications.sort((a, b) =>
      a.impact_level > b.impact_level ? 1 : -1
    );
    // this.savedData = IGCE.costEstimates
    //TODO re-map this.savedData
    const dataFromSnow = _.cloneDeep(IGCE.igceEstimateList);
    if (dataFromSnow.length > 0) {
      this.selectedClassifications.forEach((classification) => {
        // eslint-disable-next-line camelcase
        const classification_instance: CostEstimate = {
          labelShort: buildClassificationLabel(classification, "short", true),
          classificationInstanceSysId: classification.sys_id || "",
          classificationLevelSysId: typeof classification.classification_level === "object"
            ? ((classification.classification_level as ReferenceColumn)
              .value as string)
            : (classification.classification_level as string),
          offerings: [],
        };
        this.instanceData.push(classification_instance);
      });
      this.instanceData.forEach((instance) => {
        dataFromSnow.forEach((estimate) => {
          const flatData = convertColumnReferencesToValues(estimate);
          if (instance.classificationInstanceSysId === flatData.classification_instance) {
            const obj = {
              IGCE_title: flatData.title,
              IGCE_description: flatData.description,
              monthly_price: flatData.unit_price,
              isCloudServicePackage: false,
              sysIdCDS: (flatData.cross_domain_solution as ReferenceColumn)
                .value as string,
              sysIdClassificationInstance: instance.classificationInstanceSysId,
              sysIdClassificationLevel: instance.classificationLevelSysId,
              sysIdEnvironmentInstance: (
                flatData.environment_instance as ReferenceColumn
              ).value as string,
              sysId: flatData.sys_id || "",
              unit: flatData.unit,
              quantity: flatData.unit_quantity,
            };
            instance.offerings.push(obj);
          }
        });
      });
      this.savedData = _.cloneDeep(this.instanceData);
    } else {
      this.selectedClassifications.forEach((classification) => {
        if (classification.classification_level !== "") {
          // eslint-disable-next-line camelcase
          const classification_instance: CostEstimate = {
            labelShort: buildClassificationLabel(classification, "short", true),
            classificationInstanceSysId: classification.sys_id || "",
            classificationLevelSysId: typeof classification.classification_level === "object"
              ? ((classification.classification_level as ReferenceColumn)
                .value as string)
              : (classification.classification_level as string),
            offerings: [],
          };
          this.instanceData.push(classification_instance);
        }
      });

      const dowObject = DescriptionOfWork.DOWObject;
      dowObject.forEach((service) => {
        const serviceName = this.getFormattedNames(
          service.serviceOfferingGroupId
        );
        if (service.otherOfferingData && service.otherOfferingData.length > 0) {
          service.otherOfferingData.forEach((offering) => {
            if (offering.classificationLevel) {
              this.instanceData.forEach((instance) => {
                if (instance.classificationLevelSysId === offering.classificationLevel) {
                  const classificationOfferings: {
                    IGCE_title: string;
                    IGCE_description: string;
                    monthly_price: number;
                    isCloudServicePackage: boolean;
                    sysIdCDS: string;
                    sysIdClassificationInstance: string;
                    sysIdClassificationLevel: string;
                    sysIdEnvironmentInstance: string;
                    sysId: string;
                    unit: string;
                    unit_quantity: string;
                  } = {
                    IGCE_title: "",
                    IGCE_description: "",
                    monthly_price: 0,
                    isCloudServicePackage: false,
                    sysIdCDS: "",
                    sysIdClassificationInstance: "",
                    sysIdClassificationLevel: "",
                    sysIdEnvironmentInstance: "",
                    sysId: "",
                    unit: "",
                    unit_quantity: "",
                  };
                  if (offering.instanceNumber) {
                    classificationOfferings.IGCE_title =
                      // eslint-disable-next-line max-len
                      `${serviceName} - ${this.serviceOrInstance(
                        service.serviceOfferingGroupId
                      )} #${offering.instanceNumber}`;
                  } else {
                    classificationOfferings.IGCE_title = serviceName;
                  }
                  const quantityObj: Record<string, number> = {};
                  if (offering.entireDuration === "NO") {
                    offering.periodsNeeded.forEach((period) => {
                      let selected = Periods.periods.filter(
                        (selectedPeriod) => selectedPeriod.sys_id === period
                      );
                      quantityObj[period] = this.convertToMonths(
                        Number(selected[0].period_unit_count),
                        selected[0].period_unit
                      );
                    });
                    classificationOfferings.unit_quantity =
                      JSON.stringify(quantityObj);
                  } else {
                    Periods.periods.forEach((period) => {
                      if (period.sys_id) {
                        quantityObj[period.sys_id] = this.convertToMonths(
                          Number(period.period_unit_count),
                          period.period_unit
                        );
                      }
                    });
                    classificationOfferings.unit_quantity =
                      JSON.stringify(quantityObj);
                  }
                  classificationOfferings.sysIdClassificationInstance =
                    instance.classificationInstanceSysId;
                  classificationOfferings.sysIdClassificationLevel = 
                    instance.classificationLevelSysId;
                  classificationOfferings.isCloudServicePackage =
                    cloudServices.includes(serviceName);
                  const formData = this.createFormData(serviceName, offering);
                  classificationOfferings.IGCE_description =
                    formData || offering.usageDescription || "";
                  classificationOfferings.unit = serviceName
                    .toLowerCase()
                    .includes("portability")
                    ? "each"
                    : "month";
                  if (serviceName !== "Training") {
                    instance.offerings.push(classificationOfferings);
                  }
                }
              });
            }
          });
        }
        if (service.serviceOfferings.length > 0) {
          service.serviceOfferings.forEach((offering) => {
            offering.classificationInstances?.forEach(
              (classificationInstance) => {
                this.instanceData.forEach((instance) => {
                  // eslint-disable-next-line max-len
                  let classificationId =
                    typeof classificationInstance.classificationLevelSysId ===
                    "object"
                      ? // eslint-disable-next-line max-len
                      ((
                          classificationInstance.classificationLevelSysId as ReferenceColumn
                        ).value as string)
                      : (classificationInstance.classificationLevelSysId as string);
                  if (instance.classificationLevelSysId === classificationId) {
                    const classificationOfferings: {
                      IGCE_title: string;
                      IGCE_description: string;
                      monthly_price: number;
                      isCloudServicePackage: boolean;
                      sysIdCDS: string;
                      sysIdClassificationInstance: string;
                      sysIdClassificationLevel: string,
                      sysIdServicesOffering: string;
                      sysId: string;
                      unit: string;
                      unit_quantity: string;
                    } = {
                      IGCE_title: "",
                      IGCE_description: "",
                      monthly_price: 0,
                      isCloudServicePackage: false,
                      sysIdCDS: "",
                      sysIdClassificationInstance: "",
                      sysIdClassificationLevel: "",
                      sysIdServicesOffering: "",
                      sysId: "",
                      unit: "",
                      unit_quantity: "",
                    };
                    const quantityObj: Record<string, number> = {};
                    if (
                      classificationInstance.entireDuration === "NO" &&
                      classificationInstance.selectedPeriods
                    ) {
                      classificationInstance.selectedPeriods.forEach(
                        (period) => {
                          let selected = Periods.periods.filter(
                            (selectedPeriod) => selectedPeriod.sys_id === period
                          );
                          quantityObj[period] = this.convertToMonths(
                            Number(selected[0].period_unit_count),
                            selected[0].period_unit
                          );
                        }
                      );
                      classificationOfferings.unit_quantity =
                        JSON.stringify(quantityObj);
                    } else {
                      Periods.periods.forEach((period) => {
                        if (period.sys_id) {
                          quantityObj[period.sys_id] = this.convertToMonths(
                            Number(period.period_unit_count),
                            period.period_unit
                          );
                        }
                      });
                      classificationOfferings.unit_quantity =
                        JSON.stringify(quantityObj);
                    }
                    classificationOfferings.IGCE_title = `${serviceName} - ${offering.name}`;
                    classificationOfferings.sysIdClassificationInstance =
                      instance.classificationInstanceSysId;
                    classificationOfferings.sysIdClassificationLevel = 
                      instance.classificationLevelSysId;
                    classificationOfferings.isCloudServicePackage =
                      cloudServices.includes(serviceName);
                    classificationOfferings.IGCE_description =
                      classificationInstance.anticipatedNeedUsage;
                    classificationOfferings.unit = "month";
                    if (serviceName !== "Training") {
                      instance.offerings.push(classificationOfferings);
                    }
                  }
                });
              }
            );
          });
        }
      });
      this.instanceData.forEach((instance) => {
        if (instance.labelShort === "Secret / IL6") {
          if (
            ClassificationRequirements.cdsSolution?.anticipated_need_or_usage
          ) {
            const object = {
              IGCE_title: "Cross-domain solution (CDS)",
              IGCE_description:
                ClassificationRequirements.cdsSolution
                  ?.anticipated_need_or_usage,
              sysIdCDS: ClassificationRequirements.cdsSolution?.sys_id || "",
              monthly_price: "",
              isCloudServicePackage: false,
              sysIdClassificationInstance: instance.classificationInstanceSysId,
              sysIdClassificationLevel: instance.classificationLevelSysId,
              sysIdServicesOffering: "",
              sysId: "",
              unit: "month",
              trafficPerDomain: "update",
            };
            instance.offerings.push(object);
          }
        }
      });
    }
    this.instanceData.forEach((instance) => {
      instance;
      if (instance.offerings.length <= 0) {
        this.accordionClosed.push(1);
      } else {
        this.accordionClosed.push(0);
      }
    });
  }
  protected async saveOnLeave(): Promise<boolean> {
    try {
      if (this.hasChanged()) {
        await IGCE.setCostEstimate(this.currentData);
      }
    } catch (error) {
      console.log(error);
    }
    return true;
  }

  public async mounted(): Promise<void> {
    await this.loadOnEnter();
    // const slideoutPanelContent: SlideoutPanelContent = {
    //   // eslint-disable-next-line camelcase
    //   component: SlideOut_GatherPricesEstimates,
    //   title: "Learn More",
    // };
    // await SlideoutPanel.setSlideoutPanelComponent(slideoutPanelContent);
  }
}
</script>

